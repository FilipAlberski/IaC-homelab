---
# Deploy applications to K3s cluster

- name: Deploy Kubernetes applications
  hosts: masters
  become: true
  tasks:
    - name: Create temporary directory for manifests
      file:
        path: /tmp/k8s-manifests
        state: directory
        mode: '0755'

    - name: Copy kubernetes manifests to master
      copy:
        src: "{{ playbook_dir }}/../../kubernetes/"
        dest: /tmp/k8s-manifests/
        mode: '0644'

    - name: Apply core namespaces
      command: kubectl apply -f /tmp/k8s-manifests/core/
      register: core_result
      changed_when: "'created' in core_result.stdout or 'configured' in core_result.stdout"

    - name: Wait for namespaces to be ready
      command: kubectl get namespace apps
      register: namespace_check
      until: namespace_check.rc == 0
      retries: 10
      delay: 5
      changed_when: false

    - name: Apply Traefik ingress controller
      command: kubectl apply -f /tmp/k8s-manifests/ingress/
      register: ingress_result
      changed_when: "'created' in ingress_result.stdout or 'configured' in ingress_result.stdout"

    - name: Wait for Traefik to be ready
      command: kubectl get pods -n kube-system -l app=traefik
      register: traefik_check
      until: traefik_check.rc == 0
      retries: 30
      delay: 10
      changed_when: false

    - name: Apply Kubernetes Dashboard
      command: kubectl apply -f /tmp/k8s-manifests/dashboard/
      register: dashboard_result
      changed_when: "'created' in dashboard_result.stdout or 'configured' in dashboard_result.stdout"

    - name: Apply Monitoring Stack (Prometheus + Grafana)
      command: kubectl apply -f /tmp/k8s-manifests/monitoring/
      register: monitoring_result
      changed_when: "'created' in monitoring_result.stdout or 'configured' in monitoring_result.stdout"

    - name: Wait for Prometheus to be ready
      command: kubectl get pods -n monitoring -l app=prometheus
      register: prometheus_check
      until: prometheus_check.rc == 0
      retries: 30
      delay: 10
      changed_when: false

    - name: Apply sample applications
      command: kubectl apply -f /tmp/k8s-manifests/apps/whoami/
      register: apps_result
      changed_when: "'created' in apps_result.stdout or 'configured' in apps_result.stdout"
      ignore_errors: true

    - name: Wait for all pods to be running
      command: kubectl get pods -A
      register: all_pods
      until: all_pods.stdout.find('Pending') == -1 and all_pods.stdout.find('ContainerCreating') == -1
      retries: 60
      delay: 5
      changed_when: false
      ignore_errors: true

    - name: Get all pods status
      command: kubectl get pods -A -o wide
      register: pods_output
      changed_when: false

    - name: Display pods status
      debug:
        msg: "{{ pods_output.stdout_lines }}"

    - name: Get dashboard token
      command: kubectl get secret admin-user-token -n kubernetes-dashboard -o jsonpath='{.data.token}'
      register: dashboard_token_b64
      changed_when: false
      ignore_errors: true

    - name: Decode dashboard token
      set_fact:
        dashboard_token: "{{ dashboard_token_b64.stdout | b64decode }}"
      when: dashboard_token_b64.rc == 0

    - name: Display success message
      debug:
        msg:
          - "============================================"
          - "Applications deployed successfully!"
          - "============================================"
          - ""
          - "Access your services:"
          - "- Kubernetes Dashboard: http://{{ k3s_master_ip }}:30090"
          - "- Traefik Dashboard:    http://{{ k3s_master_ip }}:30880"
          - "- Prometheus:           http://{{ k3s_master_ip }}:30090"
          - "- Grafana:              http://{{ k3s_master_ip }}:30300 (admin/admin)"
          - "- AlertManager:         http://{{ k3s_master_ip }}:30093"
          - "- Whoami App:           http://{{ k3s_master_ip }}:30081"
          - ""
          - "Dashboard token (if available):"
          - "{{ dashboard_token | default('Run: make dashboard') }}"
          - ""
          - "To get token later: ./scripts/get-dashboard-token.sh"
