---
# Main playbook - full K3s cluster setup

- name: Configure all K3s nodes
  hosts: k3s_cluster
  become: true
  roles:
    - base
    - k3s-prereqs

- name: Setup K3s master
  hosts: masters
  become: true
  roles:
    - k3s-master

- name: Setup K3s workers
  hosts: workers
  become: true
  roles:
    - k3s-worker

- name: Wait for cluster to be ready
  hosts: masters
  become: true
  tasks:
    - name: Wait for all nodes to be ready
      command: kubectl get nodes
      register: nodes_result
      until: nodes_result.rc == 0
      retries: 30
      delay: 10
      changed_when: false

    - name: Display cluster nodes
      command: kubectl get nodes -o wide
      register: nodes_output
      changed_when: false

    - name: Show nodes
      debug:
        msg: "{{ nodes_output.stdout_lines }}"

    - name: Display success message
      debug:
        msg:
          - "============================================"
          - "K3s cluster is ready!"
          - "============================================"
          - ""
          - "Next steps:"
          - "1. Export kubeconfig: export KUBECONFIG=$(pwd)/kubeconfig"
          - "2. Check nodes: kubectl get nodes"
          - "3. Deploy apps: make apps-deploy"
